# Техническое задание: Корзина

## 1. Основная функциональность корзины

### 1.1 Отображение товаров
- Список товаров с информацией:
  - Изображение
  - Название
  - Артикул
  - Цена за единицу
  - Количество (с возможностью изменения)
  - Общая стоимость
- Возможность удаления товара
- Обновление всех цен при изменении количества

### 1.2 Управление количеством
- Ввод количества вручную
- Проверка на минимальное количество
- Проверка на кратность
- Автоматический пересчет всех сумм

### 1.3 Summary корзины
- Общая стоимость товаров
- Общая стоимость брендирования
- Итоговая сумма
- Обновление при любых изменениях в корзине

## 2. Брендирование

### 2.1 Доступность брендирования
- Кнопка "Добавить брендирование" активна только при наличии доступных комбинаций тип-место
- Доступность проверяется через `isAnyBrandingAvailable`
- Состояние кнопки обновляется при:
  - Загрузке страницы корзины
  - После добавления брендирования
  - После удаления брендирования

### 2.2 Отображение цен брендирования
- Цены отображаются в трех местах:
  - В строке брендирования (цена и стоимость)
  - В общей сумме брендирования для товара
  - В summary корзины (общая сумма брендирования всех товаров)
- Все места отображения цен синхронизированы
- Обновление происходит при любом изменении (количества товара, удалении брендирования)

### 2.3 Обработка ошибок брендирования
- При отсутствии opportunities или неверном формате - кнопка добавления неактивна
- При отсутствии всех цен - показ ошибки пользователю, брендирование не создается
- При отсутствии цены для конкретного количества - использование цены ближайшего меньшего количества

### 2.4 Алгоритм поиска цены брендирования
```javascript
function findBrandingPrice(opportunities, targetQuantity) {
    // Точное совпадение по количеству
    const exactMatch = pricePoints.find(p => p.quantity === targetQuantity);
    if (exactMatch) return exactMatch.price;
    
    // Ближайшее меньшее количество
    const lowerQuantity = pricePoints
        .filter(p => p.quantity < targetQuantity)
        .sort((a, b) => b.quantity - a.quantity)[0];
    if (lowerQuantity) return lowerQuantity.price;
    
    // Минимальное большее количество
    const higherQuantity = pricePoints
        .filter(p => p.quantity > targetQuantity)
        .sort((a, b) => a.quantity - b.quantity)[0];
    if (higherQuantity) return higherQuantity.price;
    
    throw new Error('No prices available for branding');
}
```

### 2.5 Интерфейс добавления брендирования
1. Кнопка "Добавить брендирование"
2. Диалог с последовательным выбором:
   - Тип печати (только типы с доступными местами)
   - Место печати (доступные для выбранного типа)
   - Количество цветов
   - Второй проход (да/нет)

### 2.6 Валидация брендирования
- Предварительная фильтрация доступных опций в UI
- Показ только доступных вариантов в выпадающих списках
- Дополнительная валидация не требуется

## 3. Обновление UI

### 3.1 При изменении количества товара
- Пересчет стоимости товара
- Пересчет базовой цены брендирования
- Пересчет цены брендирования (с учетом цветов и второго прохода)
- Пересчет стоимости брендирования (с учетом количества)
- Обновление всех мест отображения цен
- Обновление итоговой суммы в summary

### 3.2 При добавлении/удалении товара
- Обновление списка товаров
- Пересчет всех сумм
- Обновление summary

### 3.3 При добавлении/удалении брендирования
- Пересчет доступности типов и мест
- Обновление состояния кнопки
- Обновление отображения цен
- Обновление summary

## 4. Структуры данных

### 4.1 Товар в корзине
```javascript
{
  id: number,
  name: string,
  article: string,
  price: number,
  quantity: number,
  total_cost: number,
  branding: [
    {
      print_type_id: number,    // ID типа печати
      print_place_id: number,   // ID места печати
      color_count: number,      // Количество цветов
      second_pass: boolean,     // Второй проход
      price: number,            // Цена брендирования
      cost: number              // Стоимость брендирования
    }
  ]
}
```

## 5. Ограничения
- Нет возможности редактирования существующего брендирования
- Только удаление и добавление нового брендирования
- Упрощает логику проверки доступности 

## 6. Взаимодействие с сервером

### 6.1 Загрузка данных
```javascript
// Получение корзины и всех необходимых данных
GET /api/cart
Response: {
  items: Array<CartItem>
}

// Получение цен и opportunities для товара
GET /api/print-opportunities/{goods_id}
Response: {
  success: true,
  opportunities: [
    {
      id: number,
      print_type_id: number,
      print_type_name: string,
      print_place_id: number,
      print_place_name: string,
      color_quantity: number,
      place_quantity: number,
      prices: [
        {
          quantity: number,
          price: number
        }
      ]
    }
  ]
}

// Получение цен на товар
GET /api/item-price/{item_id}
Response: {
  success: true,
  // Для товаров с фиксированной ценой (standard_price = true)
  price: number,
  price_type: string,
  standard_price: true
  // ИЛИ для товаров с ценой зависящей от количества (standard_price = false)
  prices: [
    {
      quantity: number,
      price: number
    }
  ],
  price_type: string,
  standard_price: false
}
```

### 6.2 Принципы работы с данными
- Все необходимые данные загружаются при инициализации корзины
- Цены на товары и брендирование хранятся в клиентском кеше
- Все пересчеты при изменении количества происходят на клиенте
- Дополнительные запросы к серверу не требуются при:
  - Изменении количества товара
  - Расчете цен брендирования
  - Обновлении общей стоимости

## 7. Состояния и обработка ошибок

### 7.1 Состояния загрузки
- Начальная загрузка корзины и всех необходимых данных
- Добавление/удаление товара
- Добавление/удаление брендирования

### 7.2 Индикация загрузки
- Skeleton loader при начальной загрузке корзины
- Спиннер в кнопках удаления товара/брендирования
- Блокировка действий во время загрузки данных

### 7.3 Обработка ошибок
- Ошибки начальной загрузки данных
  - Повторная попытка загрузки
  - Информативное сообщение при неудаче
- Ошибки при добавлении/удалении
  - Откат к предыдущему состоянию
  - Сообщение об ошибке

## 8. Клиентский кеш

### 8.1 Структура кеша
```javascript
{
  // Цены на товары
  itemPrices: {
    [itemId: number]: {
      standard_price: boolean,
      price?: number,
      prices?: Array<{quantity: number, price: number}>,
      price_type: string
    }
  },
  
  // Opportunities для брендирования
  printOpportunities: {
    [goodsId: number]: Array<{
      id: number,
      print_type_id: number,
      print_type_name: string,
      print_place_id: number,
      print_place_name: string,
      color_quantity: number,
      place_quantity: number,
      prices: Array<{quantity: number, price: number}>
    }>
  }
}
```

### 8.2 Работа с кешем
- Инициализация при загрузке корзины
- Хранение в течение сессии
- Очистка при:
  - Выходе пользователя
  - Явном обновлении страницы
  - Ошибках в данных

## 9. Мобильная версия

### 9.1 Адаптация интерфейса
- Компактное отображение товаров
- Перенос управления количеством под информацию о товаре
- Полноэкранный диалог брендирования
- Упрощенное отображение брендирования

### 9.2 Особенности поведения
- Свайп для удаления товара
- Нативный ввод количества
- Пошаговый процесс добавления брендирования
- Оптимизация для тач-интерфейса

## 10. Производительность

### 10.1 Оптимизации
- Виртуализация списка при большом количестве товаров
- Ленивая загрузка изображений
- Прогрессивный рендеринг
- Мемоизация тяжелых вычислений

### 10.2 Метрики
- Time to Interactive < 2s
- First Contentful Paint < 1s
- Обновление UI при действиях < 100ms
- Размер бандла < 200KB (gzip) 