"use strict";(self.webpackChunkproduction=self.webpackChunkproduction||[]).push([[466],{466:(t,e,n)=>{n.r(e),n.d(e,{DISCOUNT_EVENTS:()=>l,applyDiscountsToItems:()=>p,fetchVolumeDiscounts:()=>h,initDiscountManager:()=>f,resetDiscountPrices:()=>m});const r=new class{constructor(){this.events={}}subscribe(t,e){return this.events[t]||(this.events[t]=[]),this.events[t].push(e),()=>{this.events[t]=this.events[t].filter((t=>t!==e))}}publish(t,e){this.events[t]&&this.events[t].forEach(((n,r)=>{try{n(e)}catch(e){console.error(`Error in handler for "${t}":`,e)}}))}},o="cart",s={CART_UPDATED:"cart:updated",CART_CLEARED:"cart:cleared",CART_ITEM_ADDED:"cart:item:added",CART_ITEM_REMOVED:"cart:item:removed",CART_ITEM_UPDATED:"cart:item:updated"};function c(){try{return JSON.parse(localStorage.getItem(o)||"[]")}catch(t){return console.error("Failed to get cart items from storage:",t),[]}}function i(t){try{localStorage.setItem(o,JSON.stringify(t)),r.publish(s.CART_UPDATED,t),document.dispatchEvent(new CustomEvent("cart:updated"))}catch(t){console.error("Failed to save cart items to storage:",t)}}function a(){const t=document.querySelector(".cart-count");if(t){const e=c();t.textContent=e.length,t.style.display=e.length>0?"flex":"none"}}document.addEventListener("DOMContentLoaded",a),r.subscribe("cart:add",(t=>{!function(t){const e=c(),n=e.findIndex((e=>e.id===t.id));if(n>=0)e[n].quantity+=t.quantity||1,i(e),r.publish(s.CART_ITEM_UPDATED,{item:e[n],index:n});else{const n={...t,quantity:t.quantity||1,branding:t.branding||[]};e.push(n),i(e),r.publish(s.CART_ITEM_ADDED,{item:n,index:e.length-1})}a()}(t)}));var u=n(713);const l={DISCOUNTS_APPLIED:"cart:discounts:applied",DISCOUNTS_RESET:"cart:discounts:reset",DISCOUNTS_UI_UPDATE:"cart:discounts:ui:update"};let d=null;async function f(){await h(),r.subscribe(s.CART_UPDATED,g),r.subscribe(s.CART_ITEM_UPDATED,E)}async function h(){try{const e=await fetch("/api/volume-discounts/");if(!e.ok)throw new Error("Failed to fetch volume discounts");const n=await e.json();return n.success?(d=n.discounts,t=n.discounts,localStorage.setItem("volumeDiscounts",JSON.stringify(t)),n.discounts):(console.error("Error fetching volume discounts:",n.error||"Unknown error"),null)}catch(t){return console.error("Error fetching volume discounts:",t),null}var t}async function p(){const t=JSON.parse(localStorage.getItem("cart")||"[]"),e=[];for(const n of t){const t=Number.parseInt(n.id);u.Wu.has(t)||e.push((0,u.pt)(t))}e.length>0&&await Promise.all(e);const n=function(){const t=JSON.parse(localStorage.getItem("cart")||"[]");let e=0;return t.forEach((t=>{const n=u.Wu.get(Number.parseInt(t.id));n&&n.standard_price&&(e+=t.price*t.quantity,t.branding&&t.branding.length>0&&t.branding.forEach((n=>{const r=n.secondPass?1.3:1,o=Math.round(n.price*n.colors*r*100)/100;e+=o*t.quantity})))})),e}(),o=function(t){const e=function(){if(d)return d;const t=localStorage.getItem("volumeDiscounts");if(t)try{return d=JSON.parse(t),d}catch(t){console.error("Error parsing volume discounts from localStorage:",t)}return h(),[]}();if(!e||0===e.length)return null;const n=[...e].sort(((t,e)=>t.volume-e.volume));let r=null;for(const e of n){if(!(t>=e.volume))break;r=e}return r}(n);if(!o)return console.log("No applicable discounts found"),!1;let s=!1;return document.querySelector('input[name="discount"]').value=Math.round(1e4*o.discount)/1e4,t.forEach((t=>{const e=u.Wu.get(Number.parseInt(t.id));if(e&&e.standard_price){const e=Math.round(t.price*o.discount*100)/100;t.discountPrice=e,s=!0}else t.discountPrice=t.price})),!!s&&(localStorage.setItem("cart",JSON.stringify(t)),r.publish(l.DISCOUNTS_APPLIED,{cart:t,discount:o,totalStandardPrice:n}),r.publish(l.DISCOUNTS_UI_UPDATE,{timestamp:Date.now()}),!0)}function m(){const t=JSON.parse(localStorage.getItem("cart")||"[]");let e=!1;t.forEach((t=>{t.discountPrice!==t.price&&(t.discountPrice=t.price,e=!0)})),e&&(localStorage.setItem("cart",JSON.stringify(t)),r.publish(l.DISCOUNTS_RESET,{cart:t}))}function E(){m()}function g(){m()}}}]);