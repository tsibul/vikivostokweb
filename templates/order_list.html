{% extends 'header.html' %}
{% load static %}

{% block content %}
<div class="">
    <div class="container">
        <h1 class="section-title">Мои заказы</h1>
        
        <!-- Поиск/фильтрация -->
        <div class="order-search">
            <form method="get" action="{% url 'viki_web:order_list' %}" class="order-search__form">
                <div class="order-search__input-wrapper">
                    <input type="text" name="order_no" class="order-search__input" placeholder="Номер заказа" value="{{ search_query }}">
                    <button type="submit" class="btn order-search__button">Поиск</button>
                </div>
                <button type="button" class="btn btn__cancel order-search__clear">Сбросить</button>
            </form>
        </div>
        
        {% csrf_token %}
        
        <!-- Текущие заказы -->
        <section class="order-section">
            <h2 class="order-section__title">Текущие заказы</h2>
            <div>
                <div class="order-summary__row">
                    <div class="order-list__cell">Номер</div>
                    <div class="order-list__cell">Дата</div>
                    <div class="order-list__cell">Компания</div>
                    <div class="order-list__cell">Сумма</div>
                    <div class="order-list__cell">Дней</div>
                    <div class="order-list__cell">Статус</div>
                    <div class="order-list__cell">Менеджер</div>
                    <div class="order-list__cell"></div>
                    <div class="order-list__cell"></div>
                    <div class="order-list__cell"></div>
                    <div class="order-list__cell"></div>
                </div>
                
                {% for order in active_orders %}
                <details class="order-list__item" data-order-id="{{ order.id }}">
                    <summary class="order-summary order-summary__row">
{#                        <div class="order-summary__row">#}
                            <div class="order-summary__cell">{{ order.order_no }}</div>
                            <div class="order-summary__cell">{{ order.order_date|date:"d.m.Y" }}</div>
                            <div class="order-summary__cell">{{ order.company.name }}</div>
                            <div class="order-summary__cell">{{ order.total_amount|floatformat:2 }}</div>
                            <div class="order-summary__cell">{{ order.days_to_deliver }}</div>
                            
                            <div class="order-summary__cell">
                                <div class="order-state order-state_{{ order.state.order }}">
                                    {{ order.state.name }}
                                    {% if order.state.action == 'wait_branding_approve' %}
                                        <button class="btn btn__neutral order-action" data-action="approve-branding" data-order-id="{{ order.id }}">✓</button>
                                    {% elif order.state.action == 'price_changed' %}
{#                                    <div class="order-action" data-action-type="price-change">#}
                                        <button class="btn btn__save" data-action="approve-price" data-order-id="{{ order.id }}">✓</button>
                                        <button class="btn btn__cancel" data-action="cancel-price" data-order-id="{{ order.id }}">✗</button>
{#                                    </div>#}
                                    {% endif %}
                                </div>
                            </div>
                            
                                <button class="btn btn__neutral order-summary__cell" data-manager-name="{{ order.user_responsible.first_name }} {{ order.user_responsible.last_name }}" data-manager-email="{{ order.user_responsible.email }}" data-manager-phone="{{ order.user_responsible.userextension.phone }}">
                                    {{ order.user_responsible.first_name }} {{ order.user_responsible.last_name }}
                                </button>

                                <button class="btn order-button order-button_files" data-order-id="{{ order.id }}">
                                    Файлы
                                </button>

                                <button class="btn order-button order-button_comments" data-order-id="{{ order.id }}">
                                    Комментарии
                                </button>

                                <button class="btn order-button order-button_cancel"
                                        data-action="cancel-order"
                                        data-order-id="{{ order.id }}"
                                         {% if order.state.order < 8 %} disabled {% endif %}

                                >
                                    Отменить
                                </button>

                            <div class="order-summary__cell order-summary__toggle"></div>
{#                        </div>#}
                    </summary>
                    
                    <!-- Включаем шаблон деталей заказа -->
                    {% include "order_details.html" with order=order %}
                </details>
                {% empty %}
                <div class="order-list__empty">
                    <p>У вас нет текущих заказов</p>
                </div>
                {% endfor %}
            </div>
        </section>
        
        <!-- Завершенные заказы -->
        <section class="order-section">
            <h2 class="order-section__title">Завершенные заказы</h2>
            <div class="order-list">
                <div class="order-list__header">
                    <div class="order-list__cell">Номер</div>
                    <div class="order-list__cell">Дата</div>
                    <div class="order-list__cell">Компания</div>
                    <div class="order-list__cell">Сумма</div>
                    <div class="order-list__cell">Дней</div>
                    <div class="order-list__cell">Статус</div>
                    <div class="order-list__cell">Менеджер</div>
                    <div class="order-list__cell">Файлы</div>
                    <div class="order-list__cell">Повторить</div>
                    <div class="order-list__cell"></div>
                </div>
                
                {% for order in completed_orders %}
                <details class="order-item" data-order-id="{{ order.id }}">
                    <summary class="order-summary">
                        <div class="order-summary__row">
                            <div class="order-summary__cell">{{ order.order_no }}</div>
                            <div class="order-summary__cell">{{ order.order_date|date:"d.m.Y" }}</div>
                            <div class="order-summary__cell">{{ order.company.name }}</div>
                            <div class="order-summary__cell">{{ order.total_amount|floatformat:2 }} руб.</div>
                            <div class="order-summary__cell">{{ order.days_to_deliver }}</div>
                            
                            <div class="order-summary__cell">
                                <div class="order-state order-state_{{ order.state.order }}">
                                    {{ order.state.name }}
                                </div>
                            </div>
                            
                            <div class="order-summary__cell">
                                <button class="btn order-button order-button_manager" data-manager-name="{{ order.user_responsible.first_name }} {{ order.user_responsible.last_name }}" data-manager-email="{{ order.user_responsible.email }}" data-manager-phone="{{ order.user_responsible.userextension.phone }}">
                                    {{ order.user_responsible.first_name }} {{ order.user_responsible.last_name }}
                                </button>
                            </div>
                            
                            <div class="order-summary__cell">
                                <button class="btn order-button order-button_files" data-order-id="{{ order.id }}">
                                    Файлы
                                </button>
                            </div>
                            
                            <div class="order-summary__cell">
                                <button class="btn order-button order-button_repeat" data-order-id="{{ order.id }}">
                                    Повторить
                                </button>
                            </div>
                            
                            <div class="order-summary__cell order-summary__toggle"></div>
                        </div>
                    </summary>
                    
                    <!-- Включаем шаблон деталей заказа -->
                    {% include "order_details.html" with order=order %}
                </details>
                {% empty %}
                <div class="order-list__empty">
                    <p>У вас нет завершенных заказов</p>
                </div>
                {% endfor %}
            </div>
            
            <!-- Пагинация -->
            {% if completed_orders.has_other_pages %}
            <div class="pagination">
                {% if completed_orders.has_previous %}
                <a href="?page={{ completed_orders.previous_page_number }}{% if search_query %}&order_no={{ search_query }}{% endif %}" class="pagination__link">&laquo;</a>
                {% endif %}
                
                {% for i in completed_orders.paginator.page_range %}
                    {% if completed_orders.number == i %}
                    <span class="pagination__link pagination__link_current">{{ i }}</span>
                    {% else %}
                    <a href="?page={{ i }}{% if search_query %}&order_no={{ search_query }}{% endif %}" class="pagination__link">{{ i }}</a>
                    {% endif %}
                {% endfor %}
                
                {% if completed_orders.has_next %}
                <a href="?page={{ completed_orders.next_page_number }}{% if search_query %}&order_no={{ search_query }}{% endif %}" class="pagination__link">&raquo;</a>
                {% endif %}
            </div>
            {% endif %}
        </section>
    </div>
</div>

<!-- Модальные окна -->
<div class="modal" id="manager-modal">
    <div class="modal__content">
        <div class="modal__header">
            <h3 class="modal__title">Информация о менеджере</h3>
            <button class="modal__close">&times;</button>
        </div>
        <div class="modal__body">
            <div class="manager-info">
                <div class="manager-info__row">
                    <div class="manager-info__label">Имя:</div>
                    <div class="manager-info__value" id="manager-name"></div>
                </div>
                <div class="manager-info__row">
                    <div class="manager-info__label">Email:</div>
                    <div class="manager-info__value" id="manager-email"></div>
                </div>
                <div class="manager-info__row">
                    <div class="manager-info__label">Телефон:</div>
                    <div class="manager-info__value" id="manager-phone"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="files-modal">
    <div class="modal__content">
        <div class="modal__header">
            <h3 class="modal__title">Файлы заказа</h3>
            <button class="modal__close">&times;</button>
        </div>
        <div class="modal__body">
            <ul class="files-list" id="files-list"></ul>
            <p class="files-empty" id="files-empty">Нет доступных файлов</p>
        </div>
    </div>
</div>

<div class="modal" id="comments-modal">
    <div class="modal__content">
        <div class="modal__header">
            <h3 class="modal__title">Комментарий к заказу</h3>
            <button class="modal__close">&times;</button>
        </div>
        <div class="modal__body">
            <form class="comment-form" id="comment-form">
                <input type="hidden" id="comment-order-id" name="order_id">
                <div class="comment-form__field">
                    <label class="comment-form__label" for="comment-text">Ваш комментарий:</label>
                    <textarea class="comment-form__textarea" id="comment-text" name="comment" rows="4"></textarea>
                </div>
                <div class="comment-form__actions">
                    <button type="submit" class="btn btn__save comment-form__submit">Отправить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal" id="cancel-modal">
    <div class="modal__content">
        <div class="modal__header">
            <h3 class="modal__title">Отмена заказа</h3>
            <button class="modal__close">&times;</button>
        </div>
        <div class="modal__body">
            <p class="cancel-modal__text">Вы уверены, что хотите отменить заказ?</p>
            <div class="cancel-modal__actions">
                <button class="btn btn__cancel" id="cancel-order-no">Нет</button>
                <button class="btn btn__save" id="cancel-order-yes" data-order-id="">Да, отменить</button>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'viki_web/js/order_list.js' %}" defer type="module"></script>
{% endblock %}